name: fabric
topology:
  defaults:
    kind: linux
    image: frrouting/frr:latest
    network-mode: none
    sysctls:
      net.ipv4.ip_forward: '1'
      net.ipv6.conf.all.forwarding: '1'
      net.ipv4.conf.default.rp_filter: '0'
  nodes:
    s-router-access:
      exec:
      - sysctl -w net.ipv4.ip_forward=1
      - sysctl -w net.ipv6.conf.all.forwarding=1
      - ip link set eth1 up
      - ip addr replace 10.10.0.0/31 dev eth1
      - ip -6 addr replace fd42:dead:beef:1000:0:0:0:0/127 dev eth1
      - ip link set eth2 up
      - ip addr replace 10.20.20.1/24 dev eth2
      - ip -6 addr replace fd42:dead:beef:20::1/64 dev eth2
      - ip route replace default via 10.10.0.1
      - ip -6 route replace default via fd42:dead:beef:1000:0:0:0:1
    s-router-policy:
      exec:
      - sysctl -w net.ipv4.ip_forward=1
      - sysctl -w net.ipv6.conf.all.forwarding=1
      - ip link set eth1 up
      - ip link set eth2 up
      - ip addr replace 10.10.0.1/31 dev eth1
      - ip -6 addr replace fd42:dead:beef:1000:0:0:0:1/127 dev eth1
      - ip addr replace 10.10.0.4/31 dev eth2
      - ip -6 addr replace fd42:dead:beef:1000:0:0:0:4/127 dev eth2
      - ip route replace 10.20.10.0/24 via 10.10.0.0
      - ip route replace 10.20.15.0/24 via 10.10.0.0
      - ip route replace 10.20.20.0/24 via 10.10.0.0
      - ip -6 route replace fd42:dead:beef:10::/64 via fd42:dead:beef:1000:0:0:0:0
      - ip -6 route replace fd42:dead:beef:15::/64 via fd42:dead:beef:1000:0:0:0:0
      - ip -6 route replace fd42:dead:beef:20::/64 via fd42:dead:beef:1000:0:0:0:0
      - ip route replace default via 10.10.0.5
      - ip -6 route replace default via fd42:dead:beef:1000:0:0:0:5
    s-router-upstream-selector:
      exec:
      - sysctl -w net.ipv4.ip_forward=1
      - sysctl -w net.ipv6.conf.all.forwarding=1
      - ip link set eth1 up
      - ip link set eth2 up
      - ip addr replace 10.10.0.3/31 dev eth1
      - ip -6 addr replace fd42:dead:beef:1000:0:0:0:3/127 dev eth1
      - ip addr replace 10.10.0.5/31 dev eth2
      - ip -6 addr replace fd42:dead:beef:1000:0:0:0:5/127 dev eth2
      - ip route replace 10.20.10.0/24 via 10.10.0.4
      - ip route replace 10.20.15.0/24 via 10.10.0.4
      - ip route replace 10.20.20.0/24 via 10.10.0.4
      - ip -6 route replace fd42:dead:beef:10::/64 via fd42:dead:beef:1000:0:0:0:4
      - ip -6 route replace fd42:dead:beef:15::/64 via fd42:dead:beef:1000:0:0:0:4
      - ip -6 route replace fd42:dead:beef:20::/64 via fd42:dead:beef:1000:0:0:0:4
      - ip route replace default via 10.10.0.2
      - ip -6 route replace default via fd42:dead:beef:1000:0:0:0:2
    s-router-core:
      exec:
      - sysctl -w net.ipv4.ip_forward=1
      - sysctl -w net.ipv6.conf.all.forwarding=1
      - ip link set eth1 up
      - ip addr replace 10.10.0.2/31 dev eth1
      - ip -6 addr replace fd42:dead:beef:1000:0:0:0:2/127 dev eth1
      - ip link set eth2 up
      - ip addr replace 203.0.113.1/30 dev eth2
      - ip -6 addr replace 2001:db8:ffff::1/48 dev eth2
      - ip route replace 10.20.10.0/24 via 10.10.0.3
      - ip route replace 10.20.15.0/24 via 10.10.0.3
      - ip route replace 10.20.20.0/24 via 10.10.0.3
      - ip -6 route replace fd42:dead:beef:10::/64 via fd42:dead:beef:1000:0:0:0:3
      - ip -6 route replace fd42:dead:beef:15::/64 via fd42:dead:beef:1000:0:0:0:3
      - ip -6 route replace fd42:dead:beef:20::/64 via fd42:dead:beef:1000:0:0:0:3
      - ip route replace default via 203.0.113.2
      - ip -6 route replace default via 2001:db8:ffff::2
    isp:
      exec:
      - sysctl -w net.ipv4.ip_forward=1
      - sysctl -w net.ipv6.conf.all.forwarding=1
      - ip link set eth1 up
      - ip addr replace 203.0.113.2/30 dev eth1
      - ip -6 addr replace 2001:db8:ffff::2/48 dev eth1
      - ip route replace 10.20.10.0/24 via 203.0.113.1
      - ip route replace 10.20.15.0/24 via 203.0.113.1
      - ip route replace 10.20.20.0/24 via 203.0.113.1
      - ip -6 route replace fd42:dead:beef:10::/64 via 2001:db8:ffff::1
      - ip -6 route replace fd42:dead:beef:15::/64 via 2001:db8:ffff::1
      - ip -6 route replace fd42:dead:beef:20::/64 via 2001:db8:ffff::1
    client:
      exec:
      - ip link set eth1 up
      - ip addr replace 10.20.20.2/24 dev eth1
      - ip -6 addr replace fd42:dead:beef:20::2/64 dev eth1
      - ip route replace default via 10.20.20.1
      - ip -6 route replace default via fd42:dead:beef:20::1
  links:
  - endpoints:
    - s-router-access:eth1
    - s-router-policy:eth1
  - endpoints:
    - s-router-policy:eth2
    - s-router-upstream-selector:eth2
  - endpoints:
    - s-router-core:eth1
    - s-router-upstream-selector:eth1
  - endpoints:
    - s-router-core:eth2
    - isp:eth1
  - endpoints:
    - s-router-access:eth2
    - client:eth1
