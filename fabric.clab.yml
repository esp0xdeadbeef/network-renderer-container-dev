# fabric.clab.yml
name: fabric

topology:
  defaults:
    kind: linux
    image: ghcr.io/hellt/network-multitool

  nodes:

    # --- Pre-created host bridges (realization-only; excluded from semantics) ---
    a-ctl:
      kind: linux
      network-mode: none
      labels: { semantic.ignore: "true" }
    a-svc:
      kind: linux
      network-mode: none
      labels: { semantic.ignore: "true" }
    a-end:
      kind: linux
      network-mode: none
      labels: { semantic.ignore: "true" }
    a-corp:
      kind: linux
      network-mode: none
      labels: { semantic.ignore: "true" }
    a-iot:
      kind: linux
      network-mode: none
      labels: { semantic.ignore: "true" }
    a-dmz:
      kind: linux
      network-mode: none
      labels: { semantic.ignore: "true" }
    a-lab:
      kind: linux
      network-mode: none
      labels: { semantic.ignore: "true" }
    a-obs:
      kind: linux
      network-mode: none
      labels: { semantic.ignore: "true" }
    b-corp:
      kind: linux
      network-mode: none
      labels: { semantic.ignore: "true" }
    ovl:
      kind: linux
      network-mode: none
      labels: { semantic.ignore: "true" }

    # --- WAN ---
    isp:
      labels:
        role: uplink
        site: wan

    # --- SITE A ---
    sapol:
      labels:
        role: policy
        site: a
    sacore:
      labels:
        role: core
        site: a

    sactl:
      labels:
        role: access
        site: a
    sasvc:
      labels:
        role: access
        site: a
    saend:
      labels:
        role: access
        site: a
    sacorp:
      labels:
        role: access
        site: a
    saiot:
      labels:
        role: access
        site: a
    sadmz:
      labels:
        role: access
        site: a
    salab:
      labels:
        role: access
        site: a
    saobs:
      labels:
        role: access
        site: a

    # --- SITE B ---
    sbpol:
      labels:
        role: policy
        site: b
    sbcore:
      labels:
        role: core
        site: b
    sbcorp:
      labels:
        role: access
        site: b

    # --- Overlay participants ---
    lap:
      labels:
        role: overlay
        site: ext
    vnl:
      labels:
        role: overlay
        site: ext
    vus:
      labels:
        role: overlay
        site: ext

  links:

  # ================= SITE A PLANES (realization-only; excluded from semantics) =================
  - endpoints: ["sactl:eth1", "a-ctl:eth1"]
    labels: { semantic.ignore: "true" }
  - endpoints: ["sasvc:eth1", "a-svc:eth1"]
    labels: { semantic.ignore: "true" }
  - endpoints: ["saend:eth1", "a-end:eth1"]
    labels: { semantic.ignore: "true" }
  - endpoints: ["sacorp:eth1", "a-corp:eth1"]
    labels: { semantic.ignore: "true" }
  - endpoints: ["saiot:eth1", "a-iot:eth1"]
    labels: { semantic.ignore: "true" }
  - endpoints: ["sadmz:eth1", "a-dmz:eth1"]
    labels: { semantic.ignore: "true" }
  - endpoints: ["salab:eth1", "a-lab:eth1"]
    labels: { semantic.ignore: "true" }
  - endpoints: ["saobs:eth1", "a-obs:eth1"]
    labels: { semantic.ignore: "true" }

  # Access → Policy (tenant-access)
  - endpoints: ["sactl:eth2", "sapol:eth1"]
    labels: { edge.class: "tenant-access" }
  - endpoints: ["sasvc:eth2", "sapol:eth2"]
    labels: { edge.class: "tenant-access" }
  - endpoints: ["saend:eth2", "sapol:eth3"]
    labels: { edge.class: "tenant-access" }
  - endpoints: ["sacorp:eth2", "sapol:eth4"]
    labels: { edge.class: "tenant-access" }
  - endpoints: ["saiot:eth2", "sapol:eth5"]
    labels: { edge.class: "tenant-access" }
  - endpoints: ["sadmz:eth2", "sapol:eth6"]
    labels: { edge.class: "tenant-access" }
  - endpoints: ["salab:eth2", "sapol:eth7"]
    labels: { edge.class: "tenant-access" }
  - endpoints: ["saobs:eth2", "sapol:eth8"]
    labels: { edge.class: "tenant-access" }

  # Policy → Core (policy-core)
  - endpoints: ["sapol:eth20", "sacore:eth1"]
    labels: { edge.class: "policy-core" }

  # Core → ISP (upstream)
  - endpoints: ["sacore:eth30", "isp:eth1"]
    labels: { edge.class: "upstream" }

  # ================= SITE B =================
  - endpoints: ["sbcorp:eth1", "b-corp:eth1"]
    labels: { semantic.ignore: "true" }
  - endpoints: ["sbcorp:eth2", "sbpol:eth1"]
    labels: { edge.class: "tenant-access" }
  - endpoints: ["sbpol:eth20", "sbcore:eth1"]
    labels: { edge.class: "policy-core" }
  - endpoints: ["sbcore:eth30", "isp:eth2"]
    labels: { edge.class: "upstream" }

  # ================= OVERLAY =================
  - endpoints: ["sapol:eth90", "ovl:eth1"]
    labels: { edge.class: "overlay", semantic.ignore: "true" }
  - endpoints: ["sbpol:eth90", "ovl:eth2"]
    labels: { edge.class: "overlay", semantic.ignore: "true" }
  - endpoints: ["lap:eth1", "ovl:eth3"]
    labels: { edge.class: "overlay", semantic.ignore: "true" }
  - endpoints: ["vnl:eth1", "ovl:eth4"]
    labels: { edge.class: "overlay", semantic.ignore: "true" }
  - endpoints: ["vus:eth1", "ovl:eth5"]
    labels: { edge.class: "overlay", semantic.ignore: "true" }

  # VPN exits → ISP (upstream)
  - endpoints: ["vnl:eth2", "isp:eth10"]
    labels: { edge.class: "upstream" }
  - endpoints: ["vus:eth2", "isp:eth11"]
    labels: { edge.class: "upstream" }

