name: fabric

topology:
  defaults:
    kind: linux
    image: frrouting/frr:latest
    sysctls:
      net.ipv4.ip_forward: "1"
      net.ipv6.conf.all.forwarding: "1"

  nodes:
    a-end:
      kind: bridge

    saacc:
      network-mode: none
      binds:
        - ./configs/saacc/daemons:/etc/frr/daemons:ro
        - ./configs/saacc/frr.conf:/etc/frr/frr.conf:ro
        - ./configs/saacc/vtysh.conf:/etc/frr/vtysh.conf:ro
      exec:
        - ip link set eth1 up
        - ip link set eth2 up
        - ip addr replace 10.10.0.0/31 dev eth2
        - ip -6 addr replace fd42:dead:beef:1000::0/127 dev eth2
        - ip -6 addr replace fd42:dead:beef:20::1/64 dev eth1

    sapol:
      network-mode: none
      binds:
        - ./configs/sapol/daemons:/etc/frr/daemons:ro
        - ./configs/sapol/frr.conf:/etc/frr/frr.conf:ro
        - ./configs/sapol/vtysh.conf:/etc/frr/vtysh.conf:ro
      exec:
        - ip link set eth1 up
        - ip link set eth2 up
        - ip addr replace 10.10.0.1/31 dev eth1
        - ip -6 addr replace fd42:dead:beef:1000::1/127 dev eth1
        - ip addr replace 10.10.0.2/31 dev eth2
        - ip -6 addr replace fd42:dead:beef:1001::0/127 dev eth2

    sacore:
      network-mode: none
      binds:
        - ./configs/sacore/daemons:/etc/frr/daemons:ro
        - ./configs/sacore/frr.conf:/etc/frr/frr.conf:ro
        - ./configs/sacore/vtysh.conf:/etc/frr/vtysh.conf:ro
      exec:
        - ip link set eth1 up
        - ip link set eth2 up
        - ip addr replace 10.10.0.3/31 dev eth1
        - ip -6 addr replace fd42:dead:beef:1001::1/127 dev eth1
        - ip addr replace 203.0.113.1/31 dev eth2
        - ip -6 addr replace 2001:db8:0:1::1/127 dev eth2

    isp:
      network-mode: none
      binds:
        - ./configs/isp/daemons:/etc/frr/daemons:ro
        - ./configs/isp/vtysh.conf:/etc/frr/vtysh.conf:ro
      exec:
        - ip link set eth1 up
        - ip addr replace 203.0.113.0/31 dev eth1
        - ip -6 addr replace 2001:db8:0:1::0/127 dev eth1
        - ip route replace 10.20.0.0/16 via 203.0.113.1
        - ip -6 route replace fd42:dead:beef::/48 via 2001:db8:0:1::1

    c1:
      exec:
        - ip link set eth1 up
        - ip addr replace 10.20.20.133/24 dev eth1
        - ip -6 addr replace fd42:dead:beef:20::1337/64 dev eth1
        - ip route replace default via 10.20.20.1
        - ip -6 route replace default via fd42:dead:beef:20::1

  links:
    - endpoints: ["saacc:eth1", "a-end:port1"]
    - endpoints: ["c1:eth1", "a-end:port2"]
    - endpoints: ["saacc:eth2", "sapol:eth1"]
    - endpoints: ["sapol:eth2", "sacore:eth1"]
    - endpoints: ["sacore:eth2", "isp:eth1"]
